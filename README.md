# SubFore: Subvolume Foreground Masking for Medical Image Modeling
Offical implementation of paper [Subvolume-based Foreground Masking for Medical Masked Image Modeling]()

![alt text](assets/framework.jpg "Framework")

## Contributions
We focus on improving the pre-text task by exploring two-step
masking strategy: 

- (1) Subvolume partition, which leverages 3D subvolumes to incorporate richer spatial context than standard full volume patchified methods.
- (2) Foreground Masking, which considers the semantic distribution of anatomy, aiming to exclude background air regions that lack meaningful features.
- Dice score (BTCV: `84.64%`, Flare22: `92.43%`, MM-WHS: `90.67%`, Amos22: `88.64%`, BraTS: `78.55%`)

## Main Results
![alt text](assets/segmentation.png "Segmentation")

### BTCV Segmentation Result
| Methods         | Spleen  | Rkid   | Lkid   | Gall   | Eso    | Liv    | Sto    | Aor    | IVC    | Veins  | Pan    | Rag    | Lag    | **AVG** |
|-----------------|---------|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| UNETR backbone | 
| UNETR          | 92.30%  | 93.76% | 92.87% | 61.24% | 70.95% | 96.29% | 81.28% | 88.41% | 81.82% | 70.40% | 75.86% | 64.85% | 56.99% | **79.00%** |
| MAE            | 93.90%  | 93.79% | 93.66% | 62.10% | 72.33% | 96.55% | 80.81% | 89.44% | 84.10% | 71.44% | 76.70% | 66.55% | 62.00% | **80.26%** |
| SimMIM         | 94.43%  | 94.28% | 94.14% | 59.19% | 71.54% | 96.83% | 81.94% | 90.57% | 84.78% | 72.57% | 81.12% | 66.41% | 64.59% | **80.95%** |
| Ours           | 95.66%  | 94.66% | 94.48% | 64.48% | 71.99% | 96.99% | 82.85% | 90.42% | 84.67% | 73.97% | 81.62% | 67.35% | 63.87% | **81.77%** |
| SwinUNETR backbone |
| Swin UNETR     | 95.67%  | 93.91% | 93.81% | 65.92% | 75.18% | 96.65% | 81.35% | 90.04% | 85.89% | 74.15% | 78.92% | 70.14% | 65.17% | **82.06%** |
| SimMIM         | 95.91%  | 94.70% | 94.58% | 66.46% | 75.85% | 97.17% | 89.41% | 90.56% | 86.96% | 77.34% | 81.89% | 71.01% | 69.92% | **83.98%** | 
| Tang et al.    | 96.48%  | 95.01% | 94.43% | 63.31% | 77.42% | 97.04% | 86.32% | 90.62% | 85.91% | 75.37% | 83.54% | 71.38% | 68.34% | **83.47%** |
| SwinMM         | 96.48%  | 94.93% | 94.69% | 61.89% | 76.29% | 97.07% | 85.10% | 90.24% | 86.27% | 76.19% | 84.18% | 72.86% | 70.38% | **83.58%** |
| DAE            | 96.41%  | 94.93% | 94.75% | 65.79% | 75.68% | 97.10% | 85.57% | 91.02% | 86.19% | 75.72% | 85.17% | 71.07% | 68.02% | **83.65%** |
| SDSL           | 96.47%  | 94.64% | 94.56% | 66.23% | 78.02% | 96.93% | 89.10% | 90.04% | 87.36% | 76.34% | 82.69% | 71.14% | 70.67% | **84.17%** |
| VoCo           | 96.39%  | 94.78% | 94.59% | 67.91% | 76.08% | 97.08% | 89.94% | 90.53% | 87.01% | 75.12% | 85.60% | 72.54% | 72.17% | **84.60%** |
| Ours           | 96.45%  | 94.83% | 94.63% | 66.52% | 78.57% | 97.22% | 87.57% | 91.02% | 87.42% | 77.77% | 84.95% | 71.39% | 71.96% | **84.64%** |


### Flare22 Dataset(labeld case)
| Methods         | Liver   | Esophagus | Stomach | Duodenum | Left Kidney | Right Kidney | Spleen  | Pancreas | Aorta   | Inferior vena cava | Right adrenal gland | Left adrenal gland | Gallbladder | **AVG**   |
|-----------------|---------|-----------|---------|----------|-------------|--------------|---------|----------|---------|--------------------|---------------------|--------------------|-------------|-----------|
| UNETR backbone          |         |           |         |          |             |              |         |          |         |                    |                     |                    |             |           |
| - UNETR        | 98.04%  | 96.45%    | 96.78%  | 77.50%   | 92.20%      | 89.31%       | 74.79%  | 71.32%   | 77.87%  | 78.57%             | 89.61%              | 68.50%            | 96.36%      | **85.18%** |
| - MAE          | 98.20%  | 96.59%    | 97.33%  | 78.48%   | 92.94%      | 90.15%       | 74.80%  | 70.69%   | 79.13%  | 80.47%             | 92.99%              | 72.08%            | 96.31%      | **86.16%** |
| - SimMIM       | 98.25%  | 96.67%    | 97.36%  | 79.28%   | 92.80%      | 90.48%       | 76.15%  | 78.47%   | 77.43%  | 79.33%             | 93.22%              | 72.56%            | 96.48%      | **86.81%** |
| - Ours         | 98.48%  | 96.95%    | 97.90%  | 83.15%   | 94.61%      | 92.40%       | 81.65%  | 83.70%   | 82.85%  | 83.52%             | 95.09%              | 77.15%            | 96.55%      | **89.54%** |
| Swin UNETR     |         |           |         |          |             |              |         |          |         |                    |                     |                    |             |           |
| - SwinUNETR    | 98.53%  | 96.76%    | 97.96%  | 83.64%   | 94.73%      | 92.85%       | 83.51%  | 85.26%   | 84.94%  | 87.08%             | 95.66%              | 80.76%            | 96.85%      | **90.66%** |
| - SimMIM       | 98.60%  | 96.92%    | 98.03%  | 83.86%   | 95.02%      | 93.29%       | 85.50%  | 84.88%   | 88.06%  | 86.19%             | 95.48%              | 82.10%            | 96.56%      | **91.11%** |
| SwinUNETR backbone   |         |           |         |          |             |              |         |          |         |                    |                     |                    |             |           |
| - Tang et al.  | 98.75%  | 97.20%    | 98.32%  | 84.23%   | 95.06%      | 93.53%       | 87.43%  | 86.75%   | 87.82%  | 87.08%             | 96.33%              | 83.18%            | 96.59%      | **91.71%** |
| - SwinMM       | 98.73%  | 97.13%    | 98.29%  | 84.57%   | 95.19%      | 93.58%       | 87.25%  | 87.79%   | 87.70%  | 86.37%             | 96.20%              | 83.37%            | 96.51%      | **91.74%** |
| - DAE          | 98.72%  | 97.09%    | 98.24%  | 84.26%   | 94.52%      | 92.89%       | 87.35%  | 86.98%   | 86.08%  | 86.63%             | 96.09%              | 82.46%            | 96.92%      | **91.40%** |
| - SDSL         | 98.69%  | 97.13%    | 98.13%  | 84.09%   | 95.19%      | 93.31%       | 85.69%  | 86.71%   | 87.05%  | 86.46%             | 95.83%              | 81.63%            | 97.04%      | **91.30%** |
| - VoCo         | 98.79%  | 97.26%    | 98.39%  | 85.21%   | 95.56%      | 93.90%       | 88.41%  | 87.88%   | 88.63%  | 87.77%             | 96.61%              | 84.11%            | 97.16%      | **92.28%** |
| - Ours         | 98.80%  | 97.09%    | 98.30%  | 86.06%   | 95.40%      | 94.00%       | 88.87%  | 88.54%   | 90.01%  | 86.92%             | 96.66%              | 83.68%            | 97.27%      | **92.43%** |


### MM-WHS dataset

| Methods         | LV      | W Aorta | R Ventricle | L Atrium | MLV     | R Atrium | P Artery | **Avg**  |
|-----------------|---------|---------|-------------|----------|---------|----------|----------|----------|
| UNETR          |         |         |             |          |         |          |          |          |
| - UNETR        | 87.64%  | 87.03%  | 91.83%      | 74.80%   | 83.56%  | 91.79%   | 73.10%   | **84.25%** |
| - MAE          | 89.35%  | 88.82%  | 93.05%      | 78.34%   | 85.98%  | 95.22%   | 80.21%   | **87.28%** |
| - SimMIM       | 88.43%  | 89.15%  | 92.05%      | 80.54%   | 84.47%  | 93.77%   | 78.39%   | **86.69%** |
| - Ours         | 89.94%  | 89.48%  | 92.67%      | 84.68%   | 88.15%  | 92.89%   | 76.42%   | **87.75%** |
| Swin UNETR     |         |         |             |          |         |          |          |          |
| - SwinUNETR    | 90.20%  | 90.47%  | 94.17%      | 85.37%   | 88.39%  | 93.70%   | 80.42%   | **88.96%** |
| - SimMIM       | 90.20%  | 90.34%  | 93.54%      | 86.14%   | 88.49%  | 95.67%   | 82.88%   | **89.61%** |
| Medical SSL    |         |         |             |          |         |          |          |          |
| - Tang et al.  | 90.11%  | 89.60%  | 94.20%      | 86.07%   | 87.40%  | 96.00%   | 81.41%   | **89.25%** |
| - SwinMM       | 90.57%  | 89.06%  | 94.00%      | 87.06%   | 88.94%  | 95.14%   | 82.54%   | **89.62%** |
| - DAE          | 90.00%  | 89.91%  | 93.84%      | 87.05%   | 89.55%  | 95.39%   | 81.38%   | **89.59%** |
| - SDSL         | 90.84%  | 90.14%  | 94.30%      | 88.03%   | 90.27%  | 96.07%   | 82.98%   | **90.38%** |
| - VoCo         | 89.93%  | 89.99%  | 93.59%      | 88.07%   | 89.07%  | 96.01%   | 83.89%   | **90.08%** |
| - Ours         | 91.00%  | 90.39%  | 94.16%      | 87.59%   | 90.28%  | 96.37%   | 84.90%   | **90.67%** |


### Amos22 & MSD BraTs(Task1)

| Methods         | **Amos22 (Avg)** | BraTS (TC) | BraTS (WT) | BraTS (ET) | **Overall Avg** |
|-----------------|------------------|------------|------------|------------|-----------------|
| UNETR          |                  |            |            |            |                 |
| - UNETR        | **74.35%**       | 80.21%     | 89.48%     | 56.49%     | **75.39%**      |
| - MAE          | **76.94%**       | 79.89%     | 89.51%     | 56.69%     | **75.36%**      |
| - SimMIM       | **76.39%**       | 80.48%     | 89.92%     | 57.10%     | **75.83%**      |
| - Ours         | **77.34%**       | 81.17%     | 90.19%     | 57.67%     | **76.34%**      |
| Swin UNETR     |                  |            |            |            |                 |
| - SwinUNETR    | **86.37%**       | 81.20%     | 89.45%     | 59.03%     | **76.56%**      |
| - SimMIM       | **87.27%**       | 82.72%     | 90.63%     | 60.10%     | **77.82%**      |
| Medical SSL    |                  |            |            |            |                 |
| - Tang et al.  | **87.02%**       | 81.20%     | 89.45%     | 59.03%     | **77.32%**      |
| - SwinMM       | **86.71%**       | 82.66%     | 90.49%     | 60.22%     | **77.79%**      |
| - DAE          | **87.04%**       | 82.47%     | 90.31%     | 59.71%     | **77.50%**      |
| - SDSL         | **87.19%**       | 82.67%     | 90.65%     | 60.12%     | **77.81%**      |
| - VoCo         | **88.49%**       | 82.66%     | 90.78%     | 60.46%     | **77.97%**      |
| - Ours         | **88.64%**       | 83.46%     | 90.80%     | 61.39%     | **78.55%**      |



## Settings

### Dataset

| **Dataset**          | **Modality**  | **Class**                  | **Train** | **Valid.** |
|-----------------------|--------------|----------------------------|-----------|------------|
| **Pretraining**       |              |                            |           |            |
| BTCV             | CT           | 13 organs                 | 24        | 6          |
| TCIA Covid19         | CT           | Binary                    | 722       | 49         |
| LUNA                 | CT           | -                         | 843       | 45         |
| **Downstream**        |              |                            |           |            |
| BTCV            | CT           | 13 organs                 | 24        | 6          |
| Flare22              | CT           | 13 organs                 | 100       | 31         |
| Amos22               | CT & MRI     | 15 abdominal organs       | 32        | 9          |
| MM-WHS               | CT           | 14                        | 6         | -          |
| MSD BraTs            | MRI          | 3 tumors                  | 387       | 97         |


### Configurations

- Pre-processing

| **Parameter**          | **Values**         |
|------------------------|--------------------|
| Spacing                | [1.5, 1.5, 1.5]    |
| Norm [amin, amax]      | [-175.0, 250.0]    |
| Norm [bmin, bmax]      | [0.1, 1.0]         |
| ROI Size               | 96×96×96           |
| Subvolume size         | 16×16×16           |

- Pre-training
  
| **Parameter**          | **Values**         |
|------------------------|--------------------|
| Pre-training Steps     | 1600               |
| Optimizer              | AdamW              |
| Optimization LR        | 8e-4(UNETR: 1e-4)  |
| LR Schedule            | Warmup cosine      |
| Warmup Epochs          | 20                 |
| Regularization Weight  | 5e-2               |
| Batch Size             | 4                  |

- Downstream
  
| **Parameter**          | **Values**         |
|------------------------|--------------------|
| Optimizer              | AdamW              |
| Optimization LR        | 1e-3(UNETR: 3e-4)  |
| LR Schedule            | Warmup cosine      |
| Warmup Epochs          | 20                 |
| Momentum               | 0.9                |
| Regularization Weight  | 1e-5               |
| Batch Size             | 2                  |
| Inference              | Sliding window     |
| ROI Size               | 96×96×96           |


## Model Weight(SwinUNETR)
| **Name**                | **Weight**         |
|-------------------------|--------------------|
| SSL Pretrained Weight   |  commming soon     |


## Installation
Comming Soon



# Citation
```bibtex
@article{subfore,
  title={Subvolume-based Foreground Masking for Medical Masked Image Modeling},
  author={},
  journal={},
  year={2025}
}
```